WITH geselecteerde_plots AS (
  -- STAP 1: Verbeterde plotselectie (Case-insensitive en robuuste regex)
  -- De regex accepteert nu zowel kleine letters als hoofdletters [a-zA-Z]
  SELECT plot_id, kavel_nummer
  FROM plots
  WHERE kavel_nummer REGEXP '^([1-9]|1[0-7])([a-zA-Z])?$'
    AND UPPER(kavel_nummer) != '17B'
),

landschap_vogels AS (
  -- STAP 2: Relevante landschappen en hun vogelsoorten
  -- Bron: evg_landschapstypen, evg_vogel_landschapstype
  SELECT 
    lt.id AS landschap_id,
    lt.beschrijving AS landschapstype,
    vl.soort_id
  FROM evg_landschapstypen lt
  INNER JOIN evg_vogel_landschapstype vl ON lt.id = vl.landschap_id
  WHERE lt.id NOT IN (1, 2, 10, 11, 16)
),

actieve_oppervlakte AS (
  -- STAP 3: Bepaal het totaal getelde oppervlak per jaar voor de geselecteerde plots
  -- We kijken in waarnemingen of een plot bezocht is (ongeacht welke vogel gezien is)
  -- Dit voorkomt dat het oppervlak op 0 springt als 'kenmerkende' soorten ontbreken
  SELECT 
    w.jaar,
    SUM(pjo.oppervlakte_km2) AS totaal_oppervlak_km2
  FROM (SELECT DISTINCT jaar, plot_id FROM waarnemingen) w
  INNER JOIN geselecteerde_plots gp ON w.plot_id = gp.plot_id
  INNER JOIN plot_jaar_oppervlak pjo ON w.plot_id = pjo.plot_id AND w.jaar = pjo.jaar
  GROUP BY w.jaar
),

territoria_per_landschap AS (
  -- STAP 4: Tel territoria van specifieke vogelsoorten binnen de selectie
  -- Bron: waarnemingen, soorten
  SELECT 
    lv.landschap_id,
    lv.landschapstype,
    w.jaar,
    SUM(COALESCE(w.territoria, 0)) AS totaal_territoria
  FROM landschap_vogels lv
  INNER JOIN waarnemingen w ON lv.soort_id = w.soort_id
  INNER JOIN geselecteerde_plots gp ON w.plot_id = gp.plot_id
  GROUP BY lv.landschap_id, lv.landschapstype, w.jaar
)

-- STAP 5: Finale samenvoeging met LEFT JOIN
-- Dit zorgt ervoor dat jaren met tellingen maar zonder specifieke vogels toch verschijnen
SELECT 
    ao.jaar,
    tl.landschap_id,
    tl.landschapstype,
    COALESCE(tl.totaal_territoria, 0) AS totaal_territoria,
    ao.totaal_oppervlak_km2,
    ROUND(COALESCE(tl.totaal_territoria, 0) / ao.totaal_oppervlak_km2, 4) AS vogeldichtheid_per_km2
FROM actieve_oppervlakte ao
LEFT JOIN territoria_per_landschap tl ON ao.jaar = tl.jaar
WHERE tl.landschap_id IS NOT NULL
ORDER BY ao.jaar DESC, tl.landschap_id ASC;
/* STAP 1: Bereken het totaal aantal territoria per jaar, EXCLUSIEF meeuwen.
   We filteren hier op de soort_id's om de koloniebroeders buiten de som te houden.
*/
WITH TotaalVogelsPerJaar AS (
    SELECT 
        jaar, 
        SUM(territoria) AS som_territoria
    FROM waarnemingen
    WHERE jaar >= 1958
    /* UITSLUITING: De soorten 103 t/m 112 (meeuwen) worden hier overgeslagen */
    AND soort_id NOT BETWEEN 103 AND 112
    GROUP BY jaar
),

/* STAP 2: Bereken de unieke getelde oppervlakte per jaar.
   We gebruiken de tabel 'plot_jaar_oppervlak' om te voorkomen dat 
   kilometers dubbel worden geteld door meerdere vogelsoorten.
*/
TotaalOppervlaktePerJaar AS (
    SELECT 
        jaar, 
        SUM(oppervlakte_km2) AS som_km2
    FROM plot_jaar_oppervlak
    WHERE jaar >= 1958
    /* We kijken alleen naar jaren waarvoor ook daadwerkelijk tellingen zijn ingevoerd */
    AND EXISTS (SELECT 1 FROM waarnemingen w WHERE w.jaar = plot_jaar_oppervlak.jaar)
    GROUP BY jaar
)

/* STAP 3: Combineer de vogel-totalen met de oppervlakte-totalen.
   De resulterende 'territoria_per_km2' geeft nu de dichtheid van de overige vogelsoorten.
*/
SELECT 
    v.jaar,
    v.som_territoria AS vogels_excl_meeuwen,
    ROUND(o.som_km2, 2) AS km2_geteld,
    ROUND(v.som_territoria / o.som_km2, 2) AS territoria_per_km2
FROM TotaalVogelsPerJaar v
JOIN TotaalOppervlaktePerJaar o ON v.jaar = o.jaar
ORDER BY v.jaar ASC;
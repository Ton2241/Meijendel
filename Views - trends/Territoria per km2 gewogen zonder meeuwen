/* STAP 1: Gebruik een Common Table Expression (CTE) om de ruwe data te aggregeren.
  We moeten eerst de totalen per jaar berekenen voordat we de deling kunnen maken.
*/
WITH JaarlijkseStatistieken AS (
    SELECT 
        w.jaar,
        
        /* STAP 2: Tel alle territoria bij elkaar op voor alle vogelsoorten.
           De tabel 'waarnemingen' bevat het aantal territoria per soort per plot.
        */
        SUM(w.territoria) AS totaal_aantal_territoria,
        
        /* STAP 3: Bereken de totale getelde oppervlakte.
           We koppelen 'waarnemingen' aan 'plot_jaar_oppervlak' via plot_id EN jaar.
           Dit is cruciaal omdat de omvang van een telgebied (plot) per jaar kan variÃ«ren.
        */
        SUM(pjo.oppervlakte_km2) AS totale_oppervlakte_km2
        
    FROM waarnemingen w
    INNER JOIN plot_jaar_oppervlak pjo 
        ON w.plot_id = pjo.plot_id 
        AND w.jaar = pjo.jaar
        
    /* STAP 4: Filter de startdatum zoals gevraagd (1958) */
    WHERE w.jaar >= 1958
    
    /* STAP 5: Groepeer de resultaten per jaar om de totalen per tijdsperiode te krijgen */
    GROUP BY w.jaar
)

/* STAP 6: De uiteindelijke selectie en berekening van de ratio.
   Hier transformeren we de totalen naar een gemiddelde dichtheid.
*/
SELECT 
    jaar,
    totaal_aantal_territoria,
    ROUND(totale_oppervlakte_km2, 2) AS km2_geteld,
    
    /* STAP 7: De kern-berekening: Dichtheid = Aantal / Oppervlakte.
       We gebruiken ROUND om het resultaat hanteerbaar te houden (bijv. 120.50 vogels per km2).
    */
    ROUND(totaal_aantal_territoria / totale_oppervlakte_km2, 2) AS territoria_per_km2

FROM JaarlijkseStatistieken

/* STAP 8: Sorteer chronologisch zodat de trend van 1958 tot heden zichtbaar wordt */
ORDER BY jaar ASC;
-- 1. STEL DE TELLERCODE IN
SET @gekozen_code = 'AAAA00'; 

-- 2. DE QUERY (MET EXTRA KOLOM VOOR PLOTS)
SET SESSION group_concat_max_len = 10000;

SELECT Label, Gegevens, Plots
FROM (
    -- Persoonlijke gegevens (Plots kolom is hier leeg)
    SELECT 1 AS nr, 'Naam' AS Label, CONCAT(voornaam, ' ', IFNULL(tussenvoegsel, ''), ' ', achternaam) AS Gegevens, '' AS Plots FROM tellers WHERE tellercode = @gekozen_code
    UNION ALL
    SELECT 2, 'Adres', CONCAT(straat, ' ', huisnummer), '' FROM tellers WHERE tellercode = @gekozen_code
    UNION ALL
    SELECT 3, 'Woonplaats', CONCAT(postcode, ' ', woonplaats), '' FROM tellers WHERE tellercode = @gekozen_code
    UNION ALL
    SELECT 4, 'Contact', CONCAT(IFNULL(telefoon_mobiel, '-'), ' / ', IFNULL(email, '-')), '' FROM tellers WHERE tellercode = @gekozen_code
    UNION ALL
    SELECT 5, '', '', '' 
    UNION ALL
    SELECT 6, 'Tellercode', tellercode, '' FROM tellers WHERE tellercode = @gekozen_code
    UNION ALL
    SELECT 7, 'Bandnummer', IFNULL(CAST(bandnummer AS CHAR), 'onbekend'), '' FROM tellers WHERE tellercode = @gekozen_code
    UNION ALL
    SELECT 8, '', '', '' 
    UNION ALL
    -- Statistieken
    SELECT 9, 'Meest geregistreerd', 
        (SELECT s.soort_naam 
         FROM waarnemingen w 
         JOIN soorten s ON w.soort_id = s.id 
         JOIN plot_jaar_teller pjt ON w.plot_id = pjt.plot_id AND w.jaar = pjt.jaar
         WHERE pjt.tellercode = @gekozen_code 
         GROUP BY s.id 
         ORDER BY SUM(w.territoria) DESC LIMIT 1), ''
    UNION ALL
    SELECT 10, 'Slechts éénmaal', 
        (SELECT IFNULL(GROUP_CONCAT(DISTINCT s.soort_naam ORDER BY s.soort_naam SEPARATOR ', '), 'Geen')
         FROM waarnemingen w 
         JOIN soorten s ON w.soort_id = s.id 
         JOIN plot_jaar_teller pjt ON w.plot_id = pjt.plot_id AND w.jaar = pjt.jaar
         WHERE pjt.tellercode = @gekozen_code 
         GROUP BY pjt.tellercode
         HAVING SUM(w.territoria) = 1), ''
    UNION ALL
    SELECT 11, '', '', '' 
    UNION ALL
    SELECT 12, 'Totaal records', 
        CAST((SELECT COUNT(*) 
              FROM waarnemingen w 
              JOIN plot_jaar_teller pjt ON w.plot_id = pjt.plot_id AND w.jaar = pjt.jaar 
              WHERE pjt.tellercode = @gekozen_code) AS CHAR), ''
    UNION ALL
    SELECT 13, 'Totaal territoria', 
        CAST((SELECT SUM(w.territoria) 
              FROM waarnemingen w 
              JOIN plot_jaar_teller pjt ON w.plot_id = pjt.plot_id AND w.jaar = pjt.jaar 
              WHERE pjt.tellercode = @gekozen_code) AS CHAR), ''
    UNION ALL
    SELECT 14, '', '', '' 
    UNION ALL
    -- Jaaroverzichten (Inclusief de plots per jaar)
    SELECT 15 + w.jaar, 
           CAST(w.jaar AS CHAR), 
           CONCAT(SUM(w.territoria), ' territoria'),
           GROUP_CONCAT(DISTINCT p.kavel_nummer ORDER BY p.kavel_nummer SEPARATOR ', ')
    FROM waarnemingen w
    JOIN plot_jaar_teller pjt ON w.plot_id = pjt.plot_id AND w.jaar = pjt.jaar
    JOIN plots p ON w.plot_id = p.plot_id
    WHERE pjt.tellercode = @gekozen_code 
    GROUP BY w.jaar
) AS resultaat_tabel
ORDER BY nr;